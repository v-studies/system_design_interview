# 유튜브 설계

## 1단계 문제 이해 및 설계 범위 확정

유튜브에서는 단순히 비디오를 보는 것 말고도 많은 일을 할 수 있다.

댓글, 비디오 공유, 좋아요, 구독 등등 해당 내용들을 짧은 시간안에 설계하는 것은 불가능하다

범위를 잡아야한다.

- 빠른 비디오 업로드
- 원할한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성

## 2단계 개략적 설계안 제시 및 동의 구하기

면접관이 다음의 두 영역을 설계해 줄 것을 요청하였다고 가정하자.

- 비디오 업로드 절차
- 비디오 스트리밍 절차

### 비디오 업로드 절차

![image](https://github.com/user-attachments/assets/e8643888-8705-44eb-9f5b-fd5e77955678)

해당 그림에서 다음의 두 프로세스가 병렬적으로 수행된다고 보면 된다.
- 
- 비디오 업로드
- 비디오 메타데이터 갱신.

#### 비디오 업로드

1. 비디오를 원본 저장소에 업로드
2. 트랜스 코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스 코딩이 완료되면 아래 두 내용을 병렬 처리한다.
   3a. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
   3b. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.

#### 비디오 메타데이터 갱신

사용자가 올린 비디오가 원본저장소에 업로드되는 동안, 사용자는 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.

API 서버는 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트 한다.

### 비디오 스트리밍 절차

유튜브에서는 비디오를 다운로드 받지않고 바로 영상을 볼 수 있다.

CDN을 이용해 사용자에게 가까운 서버에서 비디오를 스트리밍한다.

이때 비디오 스트리밍을 위해 데이터 전송할때 쓰이는 표준화된 통신방법이 있다.

- 애플 HTTP Live Streaming (HLS)
- MPEG-DASH
- Microsoft Smooth Streaming
- Adobe HTTP Dynamic Streaming (HDS)

## 3단계 상세 설계

지금까지는 비디오 업로드, 비디오 스트리밍 두 부분을 설계했다.

이번에는 그 두 부분을 최적화 방안에 대해 설계해보자.

### 비디오 트랜스코딩

비디오가 다른 단말에서도 순조롭게 재생되려면 다른 단말과 호환되는 비트레이트와 포맷으로 저장되어야 한다.

> 비트레이트는 비디오를 구성하는 비트가 얼마나 빨리 처리되어야 하는지를 나타내는 단위다.
> 
> 비트레이트가 높은 비디오는 일반적으로 고화질 비디오다.

비디오 트랜스코딩은 다음과 같은 이유로 중요하다.

- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다. 따라서 호환성 문제를 위해 비디오를 여러 포맷으로 인코딩해 두는것이 좋다.

- 그리고 네트워크 대역폭이 충분하지 않은 사용자는 저화질 비디오를, 대역폭이 충분한 사용자는 고화질 비디오를 보게 해주는것이 좋다.

> 인코딩 포맷은 다음 두 부분으로 구성되어 있다.
>
> - 컨테이너 : 비디오 파일, 오디오, 메타데이터를 담는 바구니 (MP4, AVI, MKV)
> - 코덱 : 비디오와 오디오를 압축하는 알고리즘 (H.264, VP8, VP9)

### 유향 비순환 그래프(DAG) 모델

비디오를 트랜스코딩하는 것은 컴퓨팅 자원을 많이 소모할 뿐 아니라 시간도 많이 드는 작업이다.

트랜스코딩에서 DAG는 작업 간의 의존성을 효율적으로 관리하고 병렬 처리로 성능을 최적화하기 위해 사용된다.

![image](https://github.com/user-attachments/assets/0e8d6676-f767-47fa-8d35-624a01ed5f17)

### 비디오 트랜스코딩 아키텍처

![image](https://github.com/user-attachments/assets/d64ecd4d-7125-462b-99bf-7a04f7cfaebd)

#### 전처리기

전처리기에서는 비디오를 분할 하여 GOP라는 비디오 스트림을 만들고 프로그래머가 만든 설정 파일에 따라 DAG를 만들어 낸다.

전처리기는 분할된 비디오의 캐시이기도 하다. 안정성을 높이기 위해 GOP와 메타데이터를 임시저장소에 저장한다.

#### DAG 스케줄러

DAG 실행 계획을 수립하고 작업을 분배하는 엔진.

#### 자원 관리자

자원관리자는 자원 배분을 효과적으로 수행하는 역할을 담당한다.

#### 임시저장소

최종 인코딩된 비디오가 생성되기 전까지, 작업 중간 결과물을 안전하게 보관

#### 인코딩된 비디오

인코딩된 비디오 최종결과물 (example.mp4)

### 시스템 최적화

해당 시스템을 최적화 할 수 있는 방법에 대해서 알아보자.

- 속도 최적화
  - 비디오 병렬 업로드 : 비디오 스트림 GOP를 병렬로 업로드하여 시간을 단축
  - CDN 사용 : CDN을 사용하여 사용자에게 가까운 서버를 사용하도록 한다.
- 안정성 최적화
  - 미리 사인된 업로드 URL : 허가받은 사용자만 업로드할 수 있도록 pre-signed URL 업로드 방식을 사용한다.
  - 워터마크 사용 : 저작물 도난 방지를 위해 워터마크를 사용하여 비디오를 보호한다.
