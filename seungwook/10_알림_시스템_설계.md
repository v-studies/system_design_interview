# 알림 시스템 설계

알림 시스템은 단순히 모바일 푸시 알림에 한정되지 않는다. 사실 알림 시스템은 모바일 푸시 알림, SMS 메시지, 이메일 세가지로 분류할 수 있다.

## 1단계 문제 이해 및 설계 범위 확정

- 푸시알림, SMS, 이메일을 지원하는 알림 시스템을 설계한다.
- 사용자가 알림을 받지 않도록 설정할 수 있어야 한다.
- 준 실시간 알림을 지원해야 한다.
- 천만건의 모바일 푸시알림, 백만건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 한다.

<br>

## 2단계 개략적 설계안 제시 및 동의 구하기

### 알림 유형별 지원 방안

- IOS 푸시 알림 : APNS (Apple Push Notification Service) 애플이 지원하는 원격 서비스를 사용한다.
- 안드로이드 푸시 알림 : FCM (Firebase Cloud Messaging) 구글이 지원하는 원격 서비스를 사용한다.
- SMS 메시지 : Twilio, Nexmo 등의 서비스를 사용한다.
- 이메일 : SendGrid 등의 서비스를 사용한다.

<img src="https://github.com/user-attachments/assets/7afbc54b-9723-4e79-b5aa-0adad204294c" width="500">

### 연락처 정보 수집 절차

알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.

이 데이터베이스에 연락처 정보를 저장할 테이블 구조는 다음과 같다.

<img src="https://github.com/user-attachments/assets/c2ce4cc8-c354-46c0-8911-e85ea0f11ee9" width="800">

한 사용자가 여러 단말을 가질 수 있고, 알림은 모든 단말에 전송되어야 하므로 위와 같이 설계하였다.

### 알림 전송 및 수신 절차

#### 초안

<img src="https://github.com/user-attachments/assets/4e741135-ac98-48c9-ae84-26263317e713" width="800">

위 설계에는 몇가지 문제가 있다

- SPOF : 알림 서비스에 서버가 하나밖에 없어서 장애가 발생하면 서비스가 중단된다.
- 규모 확장성 : 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
- 성능 병목 : 알림 서비스가 모든 알림을 한번에 보내므로, 대량의 알림을 보낼 때 성능이 저하된다.

#### 개선된 버전

<img src="https://github.com/user-attachments/assets/b9ff1261-9a57-4be5-8773-ce98095a4b89" width="800">

- 데이터베이스와 캐시를 알림 시스템의 주서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 느슨하게 한다.

<br>

## 상세 설계

### 안정성

분산환경에서 운영될 알림 시스템을 설게할 때는 안정성을 고려해야 한다.

#### 데이터 손실 방지

알림 전송 시스템의 가장 중요한 요구사항 가운데 하나는 어떤 상황에서도 알림이 소실되면 안 된다는 것이다.

알림이 지연되거나 순서가 틀려도 괜찮지만, 사라지면 곤란하다.

이 요구사항을 만족하려면 알림 시스템은 알림 데이터를 데이터베이스에 보관하고 재시도 매커니즘을 구현해야한다.

#### 알림 중복 전송 방지

분산 시스템의 특성상 가끔은 같은 알림이 중복되어 전송되기도 한다.

그 빈도를 줄이려면 중복을 탐지하는 매커니즘을 도입해야한다.

보내야할 알림이 도착하면 그 이벤트 ID를 검사하여 이미 전송한 알림인지 확인한다.

> 분산 시스템에서 네트워크의 불확실성으로 인해 중복 전송을 100% 방지 하는것은 불가능하다.  

### 수정된 설계안

<img src="https://github.com/user-attachments/assets/7f2aeae9-e5ec-45ff-b724-16c654b86a88" width="800">

