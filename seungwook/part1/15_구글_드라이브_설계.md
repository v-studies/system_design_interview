# 구글 드라이브 설계

구글 드라이브는 파일 저장 및 동기화 서비스로, 문서, 사진, 비디오, 기타 파일을 클라우드에 보관할 수 있도록 한다.

## 1단계 문제 이해 및 설계 범위 확정

### 기능적 요구 사항

- 파일 추가 (가장 쉬운 방법은 파일을 구글 드라이브 안으로 떨구는(drag-and-drop) 것이다
- 파일 다운로드
- 여러 단말에 파일 동기화. 한 단말에서 파일 추가 시 다른 단말에서 자동으로 동기화되어야 함
- 파일 갱신 이력 조회
- 파일 공유
- 파일이 편집되거나 삭제되거나 새롭게 공유되었을 때 알림 표시

### 개략적 추정치

- 가입 사용자는 5000만 명이고 1000만 명의 DAU 사용자가 있다고 가정
- 모든 사용자에게 10GB 무료 저장공간 할당
- 매일 각 사용자가 평균 2개의 파일을 업로드한다고 가정. 각 파일의 평균 크기는 500KB
- 읽기:쓰기 비율은 1:1
- 필요한 저장 공간 총량 : 5000만 사용자 x 10GB = 500PB
- 업로드 API QPS = 1000만 사용자 x 2회 업로드 / 24시간 / 3600초 = 약 240
- 최대 QPS = QPS x 2 = 480

<br>

## 2단계 개략적 설계안 제시 및 동의 구하기

### API

이 시스템은 어떤 API를 제공해야 할까? 기본적으로 세 가지 API가 필요하다.

- 파일 업로드 API
- 파일 다운로드 API
- 파일 갱신 히스토리 API

### 동기화 충돌

구글 드라이브에서는 두 명 이상의 사용자가 같은 파일이나 폴더를 동시에 업데이트 하려고 할 때 충돌이 발생할 수 있다.

먼저 처리되는 변경은 성공한 것으로 보고, 나중에 처리되는 변경은 충돌이 발생했다고 보고 사용자에게 알린다.

![image](https://github.com/user-attachments/assets/f226330e-4e92-4ca1-9ef3-10bc1e6e76bc)

이 상태에서 사용자는 두 파일을 하나로 합칠지 아니면 둘 중 하나를 다른 파일로 대체할지를 결정해야 한다.

### 개략적 설계안

![image](https://github.com/user-attachments/assets/5f95d21b-2e8e-4a07-ba50-83f8dbc06d8d)

<br>

## 3단계 상세 설계

개략적 설계 그림을 좀 더 상세하게 알아보자

### 블록 저장소 서버

큰 파일들은 업데이트가 일어날 때마다 전체 파일을 서버로 보내면 네트워크 대역폭을 많이 사용하게 된다.

이를 최적화 하기 위해 두가지 방법을 사용할 수 있다.

- 델타 동기화(Delta Sync) : 파일이 수정되면 수정이 일어난 블록만 동기화한다.
- 압축 : 블록 단위로 압축해두면 데이터 크기를 많이 줄일 수 있다. 이때 압축 알고리즘은 파일 유형에 따라 정한다.

블록저장소는 클라이언트가 보낸 파일을 블록 단위로 나눠야 하고, 각 블록에 압축 알고리즘을 적용하고, 암호화 까지 해야한다.

![image](https://github.com/user-attachments/assets/4ea051a7-9e53-49e8-8526-c1620c51b9c1)

아래 그림은 델타 동기화 전략이 어떻게 동작하는지 보여준다.

![image](https://github.com/user-attachments/assets/8636f1a1-8938-4c36-b478-d2881243065c)

### 높은 일관성 요구사항

구글 드라이브는 같은 파일이 단말이나 사용자에 따라 다르게 보이면 안된다.

따라서 **최종 일관성(eventual consistency)모델**인 메모리 캐시가 아니라 **강한 일관성(strong consistency)모델**인 관계형 데이터베이스를 사용해야 한다.

관계형 데이터베이스는 ACID를 보장하므로 강한 일관성을 보장하기 쉽다.

### 업로드 절차

사용자가 파일을 업로드하면 무슨일이 벌어지는지 살펴보자.


![image](https://github.com/user-attachments/assets/3623a491-512b-4b0f-a784-e0044f514804)

업로드는 두개요청이 병렬적으로 전송된다.

첫번째 요청은 파일 메타데이터를 추가하기 위한 것이고, 두번째 요청은 파일을 클라우드 저장소로 업로드 하기 위한것이다.

### 다운로드 절차

파일 다운로드는 파일이 새로 추가되거나 편집되면 자동으로 시작된다.

![image](https://github.com/user-attachments/assets/4ebfdeda-7c37-49ec-a449-691bd062edae)

클라이언트가 접속중이면 알림 서비스를 이용해 새 버전을 끌어가야 한다고 알려준다.

만약 클라이언트가 접속중이 아니라면, 저장해뒀다가 클라이언트가 접속하면 다운로드를 시작한다.

### 알림 서비스

알림 서비스에 목적은 충돌이 최대한 발생하지 않도록 변경에 대해서 사용자에게 알려주는 것이다.

구현 방법으로는 두가지 방법이 있다.

- 롱 폴링
- 웹 소켓

둘다 좋은 방법이지만 구글 드라이브 설계에서는 **롱 폴링**을 사용할 것 이다.

왜냐하면 웹소켓은 실시간 양방향 통신이 요구되는 채팅 같은 응용에 적합하다. 

구글 드라이브는 양방향 통신이 필요하지 않고 알림을 보낼일이 그렇게 자주 발생하지 않으며 보내야 하는 경우에도 단 시간에 많은 양의 데이터를 보낼일은 없다.






