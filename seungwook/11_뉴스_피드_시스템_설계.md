# 뉴스 피드 시스템 설계

뉴스피드는 홈페이지 중앙에 지속적으로 업데이트되는 스토리들로, 팔로하는 사람들, 페이지, 좋아요 표시한 사람들의 활동을 기반으로 보여준다.

## 1단계 문제 이해 및 설계 범위 확정

- 사용자는 뉴스피드 페이지에 새로운 스토리를 올릴 수 있어야 하고, 친구들이 올리는 스토리를 볼 수 있어야 한다.
- 뉴스 피드 순서는 시간 역순으로 정렬되어야 한다.
- 최대 친구 수는 5,000명이다.
- 10million DAU

<br>

## 2단계 개략적 설계안 제시 및 동의 구하기

뉴스 피드 시스템을 위해서는 피드 발행과 뉴스 피드 생성 두가지 주요 기능이 필요하다.

### 피드 발행 

사용자가 스토리를 포스팅하면 해당 스토리를 피드로 발행한다.

<img src="https://github.com/user-attachments/assets/3b187748-31e0-4818-9d13-9d5a9623908d" width="500">

- 사용자 : 새 포스팅을 올리는 주체다. POST /v1/me/feed API를 이용한다.
- 포스팅 저장 서비스 : 새 포스팅을 데이터베이스와 캐시에 저장한다.
- 포스팅 전송 서비스 : 새 포스팅을 친구의 뉴스 피드에 푸시한다.
- 알림 서비스 : 친구들에게 새 포스팅 알림을 보낸다.

### 뉴스 피드 생성 

모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다.

<img src="https://github.com/user-attachments/assets/5e94edbf-c520-44b6-9f13-0cd159220557" width="500">

- 사용자 : 뉴스 피드를 읽는 주체다. GET /v1/me/feed API를 이용한다.
- 뉴스 피드 서비스 : 캐시에서 뉴스 피드를 가져오는 서비스다.
- 뉴스 피드 캐시 : 뉴스 피드를 렌더링할 때 필요한 피드 ID를 보관한다.

<br>

## 3단계 상세 설계

아래에서 피드 발행 흐름 상세 설계에 대해서 알아보자.

### 포스팅 전송(팬아웃) 서비스

포스팅 전송, 즉 팬아웃은 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.

팬아웃에는 두 가지 모델이 있다.

- 쓰기 시점에 팬아웃하는 모델 (push 모델)
- 읽기 시점에 팬아웃하는 모델 (pull 모델)

#### 쓰기 시점에 팬아웃하는 모델

포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록한다.

장점으로는 새 포스팅을 발행 하는 순간 이미 갱신되므로 사용자가 뉴스 피드를 읽을 때 빠르게 뉴스 피드를 볼 수 있다.

그러나 친구가 많은 사용자의 경우 팬아웃 작업이 많아져서 서비스가 느려질 수 있다. (핫키 문제)

#### 읽기 시점에 팬아웃하는 모델

사용자가 본인 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져오는 방식이다.

장점으로는 비활성 사용자, 로그인을 많이 하지 않는 사용자에게는 불필요한 팬아웃 작업을 줄일 수 있고 핫키 문제가 발생하지 않는다.

그러나 사용자가 뉴스 피드를 읽을 때 느릴 수 있다.

#### 해당 설계안에서 선택한 내용

뉴스 피드를 빠르게 가져올 수 있도록 하는것은 아주 중요하므로 대부분의 사용자는 push 모델을 사용하고, 핫키 문제가 발생할 수 있는 사용자는 pull 모델을 사용하도록 한다.

아울러 안정 해시를 통해 요청과 데이터를 보다 고르게 분산하여 핫키 문제를 줄일 수 있다.

아래 그림을 통해 팬아웃 서비스가 어떻게 동작하는지 알아보자

<img src="https://github.com/user-attachments/assets/6d29c204-8888-45c7-b668-e1a11625e04b" width="600">


- 그래프 데이터베이스에서 친구 ID 목록을 가져온다.
- 사용자 정보 캐시에서 친구 정보를 가져온다.
- 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣는다.
- 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내어 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다.

> 그래프 데이터베이스?
> 
> 







