# 키-값 저장소 설계

키-값 저장소는 키-값 데이터베이스라고도 불리는 비 관계형(non-relational) 데이터베이스이다.

## 분산 키-값 저장소

많은 데이터를 저장하려면 분산 키-값 저장소를 만들 필요가 있고, 분산시스템을 설계할 때는 CAP 정리를 이해하고 있어야한다.

### CAP 정리

CAP 정리는 데이터 일관성, 가용성, 파티션감내라는 세가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리다.

어떤 두 가지를 충족하려면 나머지 하나는 반드시 희생되어야 한다.

- 일관성(Consistency): 분산 시스템에 접속하는 모든 클라이언트가 동일한 데이터를 볼 수 있어야한다.
- 가용성(Availability): 일부 노드에 장애가 발생하더라도 시스템이 정상적으로 동작해야한다.
- 파티션감내(Partition Tolerance): 네트워크 장애로 인해 일부 노드간 통신이 불가능해도 시스템이 정상적으로 동작해야한다.



<img src="https://github.com/user-attachments/assets/99dc1447-8961-44c3-b8c9-a43aa351729c" width="800">

- CP : 일관성과 파티션감내를 만족하려면 가용성을 희생한다.
- AP : 가용성과 파티션감내를 만족하려면 일관성을 희생한다.
- CA : 일관성과 가용성을 만족하려면 파티션감내를 희생한다.
  - 그러나 통상 네트워크 장애는 피할 수 없는 일로 여겨지므로, 분산 시스템은 반드시 파티션 문제를 감내하도록 설계되어야 한다. 그러므로 실세계에 CA 시스템은 존재하지 않는다.

### 실세계의 분산 시스템

분산 시스템은 파티션 문제를 피할 수 없다. 파티션 문제가 발생하면 우리는 일관성과 가용성 사이에서 하나를 선택해야 한다.


아래 그림은 n3에 장애가 발생하여 n1 및 n2와 통신할 수 없는 상황을 보여준다.

n3에 기록되었으나 아직 n1 및 n2로 전달되지 않은 데이터가 있다면 n1과 n2는 오래된 사본을 갖고 있을 것이다.

![image](https://github.com/user-attachments/assets/be2eb6f8-0346-4a62-b46d-8780c7462ba1)


- 가용성 대신 일관성을 선택한다면(CP) 세 서버 사이에 생길 수 있는 데이터 불일치 문제를 피하기 위해 n1과 n2에 대해 쓰기 연산을 중단 시킨다 
  - 가용성 깨짐, MongoDB 등 금융 거래, 데이터 정합성이 매우 중요한 시스템에 적합
- 일관성 대신 가용성을 선택한다면(AP) 설사 낡은 데이터를 반환할 위험이 있더라도 계속 읽기 연산을 허용해야 한다. 
  - 일관성 깨짐, DynamoDB, Cassandra 등 빠른 응답이 중요한 시스템에 적합





