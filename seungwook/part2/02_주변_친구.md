# 2장 주변 친구

근접성 서비스와 비슷해보이지만 다른점은 사업장 주소는 정적이지만, 주변 친구 위치는 자주 바뀔 수 있다.

## 요구사항

- 주변 친구는 5마일(8km) 반경 이내 친구로 정의
- 친구 위치 정보는 30초 주기로 갱신
- DAU는 1억명이고 10%(천만명)에 해당하는 유저가 동시 사용
- 평균적으로 한 사용자는 400명의 친구를 갖는다.

<br>

## 개략적 설계안

![Image](https://github.com/user-attachments/assets/b1f63e91-a407-4e87-99da-9562669cfd07)

- 모든 활성 상태 사용자의 위치 변화 내역을 수신한다.
- 사용자 위치가 변경 될때마다, 활성 상태인 친구에서 변경 내역 전달한다. 

문제는 큰 규모에 적용하기 쉽지 않다.

- 활성 상태의 동시 접속 사용자가 천만 명 정도에 위치 정보를 30초마다 갱신하면 초당 334,000번 위치 정보 갱신
- 평균 사용자가 1명은 400명 친구를 갖고, 그 가운데 10%가 인근 활성화 상태라고 가정하면 1,400만건 위치 정보 갱신 요청
  - 초당 334,000 * 400 * 10% = 1,400만

이 엄청난 양의 갱신 내역을 사용자 단말로 보내야 한다.

그래서 아래에서 웹소켓 서버와 레디스 pub/sub을 활용한 설계를 사용해야한다.

## 설계안

![Image](https://github.com/user-attachments/assets/208fb55f-5a3f-4e90-ae7e-00b610d7a325)

1. 클라이언트 위치 변경 사실을 로드밸런서에 전송
2. 로드밸러서는 그 위치 변경 내역을 웹소켓 서버로 전송
3. 웹소켓 서버는 해당 이벤트를 위치 이동 데이터베이스에 저장
4. 웹소켓 서버는 캐시에 저장. TTL도 갱신
5. 웹소켓 서버는 레이스 펍/섭 서버에 해당 사용자 채널에 위치 발행. 3~5는 병렬로 수행
6. 레디스 펍/섭 모든 구독자(온라인 친구)에게 브로드캐스트
7. 새 위치를 보낸 사용자와 메시지를 받은 사용자 사이의 거리를 새로 계산한다.




