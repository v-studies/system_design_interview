# 11장 결제 시스템

## 결제 서비스 데이터 모델

결제 시스템용 저장소 솔루션을 고를 때 일반적으로 성능은 가장 중요한 고려사항은 아니다.

일반적으로는 NoSQL/NewSQL보다는 ACID 트랜잭션을 지원하는 전통적인 관계형 데이터베이스를 선호한다.

## 결제 실패 처리

모든 결제 시스템은 실패한 결제를 적절히 처리할 수 있어야 한다.

![Image](https://github.com/user-attachments/assets/aa309258-6718-4326-bf49-253a55675ece)

- 재시도 큐 : 일시적 오류 같은 재시도 가능 오류는 재시도 큐에 보낸다.
- 실패 메시지 큐 : 반복적으로 처리에 실패한 메시지는 결국에는 실패 메시지 큐로 보낸다. 나중에 원인 파악에 유용하다.

## 정확히 한 번 전달

결제 시스템에 발생 가능한 가장 심각한 문제 중 하나는 고객에게 이중으로 청구하는 것이다.

메시지를 정확히 한 번 전달하는 것은 매우 어려운 문제처럼 느껴지지만, 문제를 두 부분으로 나누면 훨씬 쉽게 해결할 수 있다.

- 최소 한 번은 실행된다.
- 최대 한 번 실행된다.

재시도를 통해 최소 한 번 실행을 보증하는 방법과, 멱등성 검사를 통해 최대 한 번 실행을 보증하는 방법을 알아보자.

### 재시도

간혹 네트워크 오류나 시간 초과로 인해 결제 거래를 다시 시도해야 하는 경우가 있다.

재시도 매커니즘을 활용하면 어떤 결제가 최소 한 번은 실행되도록 보장 가능하고 얼마나 간격을 두고 재시도할지 정하는 것이 중요하다.

- 즉시 재시도 : 클라이언트는 즉시 요청을 다시 보낸다.
- 고정 간격 : 재시도 전에 일정 시간 기다리는 방안이다.
- 증분 간격 : 재시도 전에 기다리는 시간을 특정한 양 만큼 점진적으로 늘려 나가는 방안이다.
- 지수적 백오프 : 재시도 전에 기다리는 시간을 직전 재시도 대비 두 배씩 늘려 나가는 방안.
- 취소 : 요청을 철회하는 방안

### 멱등성

재시도 시 발생할 수 있는 잠재적 문제는 이중 결제다.

이중 결제를 방지하려면 결제는 최대 한 번 이루어져야 한다. 최대 한 번 실행은 다른 말로 멱등성이라고도 부른다.

![Image](https://github.com/user-attachments/assets/f12b6435-30ef-4492-a73e-8adb51bca4fb)

- 사용자가 결제를 클릭하면 멱등 키가 HTTP 요청의 일부로 결제 시스템에 전송된다.
- 전자상거래에서 멱등 키는 일반적으로 결제가 이루어지기 직전의 장바구니 ID다. 
- 해당 키는 데이터베이스 고유 키 제약 조건을 활용한 키로 요청이 실패하고 멱등성이 지켜진다.



