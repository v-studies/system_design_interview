# 6장 광고 클릭 이벤트 집계

### 데이터 모델

이 시스템이 다루는 데이터는 두 종류로 나눌 수 있다.

- 원시 데이터
  - 어떤 유저가 언제 어떤 광고를 클릭했는지
- 집계 데이터
  - 광고 클릭 이벤트가 매분 집계된 집계결과

원시 데이터는 양이 엄청나므로 직접 질의하는 것은 비효율적이다.

원시 데이터는 디버깅용으로 남겨두고 집계데이터를 질의에 활용해야 한다.

### 데이터베이스 선택

#### 원시데이터

원시데이터는 백업과 재계산 용도로만 이용되므로 이록적으로 읽기 연산 빈도는 낮고 쓰기 빈도가 더 높다.

쓰기 및 범위 질의에 최적화된 카산드라나 influxDB를 사용하는게 좋다.

#### 집계데이터

집계데이터는 본질적으로 시계열 데이터이며 이 데이터를 처리하는 워크플로는 읽기 연산과 쓰기 연산을 둘다 많이 사용한다.

각 광고에 대해 매 분마다 데이터베이스에 질의를 던져 고객에게 최신 집계 결과를 제시해야 하기 때문이다.

원시데이터와 집계 결과 데이터를 저장하는데 같은 데이터베이스를 활용하는것이 좋다.

### 개략적 설계안

동기식으로 처리하게 되면 트패릭이 갑자기 증가하여 발생하는 이벤트 수가 소비자의 처리 용량을 넘게되는 경우, 소비자는 메모리 부족 오류를 겪을 수 있다.

그래서 보통 비동기 처리하여 생산자와 소비자의 결합을 끊어주기 위해 큐를 많이 사용한다.

![Image](https://github.com/user-attachments/assets/5c898220-958f-45ce-a92b-c55efce83035)

- 첫 번째 메시지 큐는 광고 클릭 이벤트 데이터가 기록된다.
- 두 번째 메시지 큐는 집계 데이터들이 들어오게 된다.

집계 데이터를 바로 데이터베이스에 기록하지 않는 이유는 정확하게 한 번(exactly once) 데이터를 처리하기 위해(원자적 커밋)

카프카 같은 시스템을 두 번째 메시지 큐로 도입해야 하기 때문이다.
