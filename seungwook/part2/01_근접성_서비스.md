# 1장 근접성 서비스

이번 장에서는 근접성 서비스를 설계한다.

근접성 서비스는 음식점, 호텔, 극장, 주유소 등 사용자의 위치 주변에 있는 사업장을 찾아주는 서비스다.

## 요구사항

- 사용자의 위치(위도와 경도)와 검색 반경 정보에 매치되는 사업장 목록을 반환
- 사업장 소유주가 사업장 정보를 추가, 삭제, 갱신할 수 있도록 하되, 그 정보가 검색 결과에 실시간으로 반영될 필요는 없다고 가정
- 고객은 사업장의 상세 정보를 살필 수 있어야 함


### 위치기반 서비스(LBS)

LBS는 시스템의 핵심 부분으로, 주어진 위차와 반경 정보를 이용해 주변 사업장을 검색한다.

- 쓰기 요청이 없는, 읽기 요청만 빈번하게 발생한다.
- QPS가 높다. 특히 특정 시간대의 인구 밀집 지역일수록 그 경향이 심하다.
- 무상태 서비스이므로 수평적 규모 확장이 쉽다.

### 사업장 서비스

사업장 소유주가 정보를 생성, 갱신, 삭제하고 사용자는 정보를 조회한다.

- QPS는 높지 않다.
- 고객이 사업장 정보를 조회한다. 특정 시간대에 QPS가 높아질 수 있다.

## 주변 사업장 검색 알고리즘

### 1. 2차원 검색

주어진 반경으로 그린 원 안에 놓인 사업장을 검색하는 방법이다. 가장 직관적이지만 지나치게 단순하다는 문제가 있다.

- 위도 경도를 between문 으로 테이블을 전부 읽어야 하므로 효율적이지 않다.

### 2. 균등 격자

공간을 균등한 격자로 나누고, 각 격자에 속한 사업장을 저장하는 방법이다. -> 지구 전체를 같은 크기의 격자로 나누는 방법

일반적으로 위도와 경도를 기준으로 고정 크기의 셀로 분할한다.

- 공간을 균등하게 나누기 때문에, 인구 밀집 지역에서는 사업장이 특정 격자에 몰리는 문제가 생길 수 있다.
- 사람이 거의 없는 지역도 동일하게 관리해야 하므로 리소스 낭비가 발생할 수 있다.

### 3. 지오해시(GeoHash)

지오해시는 2차원의 위도 경도 데이터를 1차원의 문자열로 변환한다.

이 문자열은 공간 위치를 계층적으로 표현하며, 같은 지역은 비슷한 접두어(Prefix)를 갖는다.

> 처음에는 지구 전체를 큰 네모로 나누고 그 네모를 더 작은 네모로 나누는 과정을 반복한다.
>
> 이렇게 나눌 때마다 새로운 글자(지오해시 문자)가 하나씩 추가하여
>
> 문자열이 길어질수록 더 많이 분할된, 더 작은 셀을 의미한다.

- 공간적으로 인접한 위치는 비슷한 문자열을 가지므로, 범위 검색 시 prefix 기반 탐색으로 빠르게 조회할 수 있다.
- 데이터가 발생한 위치만 인코딩하면 되므로, 빈 공간에 대한 불필요한 인덱싱이 줄어들어 효율적인 저장과 검색이 가능하다.

### 4. 쿼드트리

쿼드트리는 2차원 공간을 4등분하여 계층적으로 나누는 트리 구조이다.

이 구조는 데이터가 있는 지역만 더 세분화하므로, 공간을 효율적으로 표현할 수 있다.

- 데이터가 많은 지역만 정밀하게 분할하므로, 저장 공간과 탐색 성능 측면에서 효율적이다.
- 불균형한 공간 분포에도 유연하게 대응할 수 있어 범위 검색, 근접 이웃 검색 등에 적합하다.


### 5. 구글 S2

S2는 구글에서 만든 지구 표면을 분할하는 공간 인덱싱 시스템이다.

지구를 구면체로 보고, 이를 정육면체로 변환한 뒤 각 면을 다시 계층적으로 분할한다.

- 높은 정밀도로 지리적 위치를 표현하며, 다양한 크기의 셀을 통해 유연한 검색이 가능하다.

## 상세설계

### 데이터베이스의 규모 확장성

#### 지리 정보 색인 테이블

본 설계안에서는 지오해시를 사용하도록 하자

지오해시 테이블 구성 방법으로는 2가지가 있다.

1. 각각의 지오해시에 연결되는 모든 사업장 ID를 JSON 배열로 만들어 같은 열에 저장하는 방식

|geohash|business_ids|
|---|---|
|wx4g0ec|["B001", "B002", "B010"]|
|wx4g0ed|["B003", "B005"]|
|wx4g0ee|["B004"]|


2. 같은 지오해시에 속한 사업자 ID 각각을 별도 열로 저장하는 방식

|geohash|business_id|
|---|---|
|wx4g0ec|B001|
|wx4g0ec|B002|
|wx4g0ec|B010|
|wx4g0ed|B003|
|wx4g0ed|B005|
|wx4g0ee|B004|


지오해시 기반으로 데이터 규모가 커지고, 추가,삭제가 빈번하다면 1번은 매번 파싱을 해야하므로 2번 방식이 훨씬 더 확장성과 성능에 유리하다.

### 지리 정보 색인의 규모 확장

읽기 연산의 빈도가 높을 경우 단일 서버의 CPU와 네트워크 대역폭으로 감당하지 못할 수 있으므로 여러 데이터베이스 서버로 부하를 분산해야한다.

1. 리플리케이션

여러 사본 데이터베이스 서버를 추가하여 읽기 부하를 분산

- 개발이 상대적으로 쉽고 관리가 간편하다.

2. 샤딩

데이터베이스를 여러 샤드로 분할하여 부하를 분산.

- 샤딩 로직을 애플리케이션 계층에 구현해야 하므로 개발이 복잡하다.

### 캐시

지오해시를 사용할때는 캐시키 값을 지오해시로 사용하면 좋다.

|key|value|
|---|---|
|지오해시|사업장 ID 목록|
|사업장 ID|사업장 정보|

이렇게 사용하면 캐시를 통해 지오해시에 해당하는 사업장 ID 목록을 빠르게 조회할 수 있다.



### 최종 설계도

![Image](https://github.com/user-attachments/assets/4497d7ca-7314-445d-aebe-8ce989dde2b7)


