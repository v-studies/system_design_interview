# 5장 지표 모니터링 및 경보 시스템

이번 장에서는 규모 확장이 용이한 지표 모니터링 및 경보 시스템의 설계안을 살펴보자.

어떤 종류에 모니터링 서비스인지 확인이 필요하다.

- 인프라 지표 모니터링
- 웹 서버 에러로그나 액세스 로그에 초점을 맞춘 모니터링

이번장에서는 시스템 운영지표를 중심으로 모니터링 시스템을 설계해본다. (cpu 부하, 메모리 사용률 등등)


### 기본구성

지표 모니터링 및 경보 시스템은 일반적으로 다섯가지 컴포넌트를 이용한다.

- 데이터 수집 : 여러 출처로부터 지표 데이터를 수집한다.
- 데이터 전송 : 지표 데이터를 지표 모니터링 시스템으로 전송한다.
- 데이터 저장소 : 전송되어 오는 데이터를 정리하고 저장한다.
- 경보 : 데이터를 분석하고 이상 징후를 감지하고, 경보를 발생시킨다.
- 시각화 : 데이터를 차트나 그래프 등으로 제공한다.

![Image](https://github.com/user-attachments/assets/aeeba3bb-b2c8-41d5-b769-af91eafabf43)

### 데이터모델

지표 데이터는 통상 시계열 데이터 형태로 기록한다. 값 집합에 타임스탬프가 붙은 형태로 기록한다는 뜻이다.

#### 어떤 데이터베이스를 사용해야할까?

시계열 데이터를 저장하기 위해서는 RDBMS를 잘 사용하지 않는다.

왜냐하면 sql로 시계열 데이터를 처리하기가 힘들고 관계형 데이터베이스는 통상적으로 수행하는 연산에 최적화 되어 있지 않아 오래걸리기 때문이다.

nosql은 어떨까?

시계열 데이터를 효과적으로 저장하고 질의하기 위해서는 확장이 용이한 스키마를 설계해야 하는데, 그러려면 해당 nosql 데이터베이스의 내부 구조에 대한 해박한 지식이 필요하다.

기업에 필요한 규모를 지원하는 시계열 데이터베이스가 시장에 나와있는 만큼 범용 nosql 데이터베이스를 사용하는 방안은 그다지 매력적이지 않다. 

- 시장에서 가장 인기있는 시계열 데이터베이스는 프로메테우스와 influxDB이다.

### 개략적 설계안

![Image](https://github.com/user-attachments/assets/5d56d01b-7e6c-4aa0-b1fd-dd3bccf3e6f5)

<br>

## 상세 설계

지표 수집 방법에 대해서 좀 더 자세히 알아보자.

### 지표 수집

지표 데이터를 수집방법에는 풀 모델과 푸시 모델 방법이 존재한다.

#### 풀 모델

실행중인 애플리케이션에서 주기적으로 지표 데이터를 가져오는 지표 수집기가 이 흐름에 중심이다.

지표수집기는 데이터를 가져올 서비스 목록을 알고있어야한다.

서버가 수시로 추가/삭제되는 대규모 운영환경을 위해 주키퍼와 같은 discovery를 사용하면 대규모 환경에서도 사용할 수 있다.

![Image](https://github.com/user-attachments/assets/d559ef18-9b8a-4943-911d-9c9ed751b95f)

#### 푸시모델

웹 서버나 데이터베이스 서버 같은 서버가 직접 지표를 수집기에 전송하는 모델이다.

푸시 모델의 경우, 모니터링 대상 서버에 통상 수집 에이전트(collection agent)라고 부르는 소프트웨어를 설치한다.

수집 에이전트는 해당 장비에서 실행되는 서비스가 생산하는 지표 데이터를 받아 모은 다음 주기적으로 수집기에 전달한다.

![Image](https://github.com/user-attachments/assets/b2007a91-7a76-4e8f-b573-2c54c6870f45)

- 풀 모델을 채택한 유명한 사례로는 프로메테우스가 있다.
- 푸시 모델을 채택한 유명한 사례로는 아마존 클라우드와치, 그래파이트 등이 있다.


### 지표 전송 파이프라인의 규모 확장

지표 수집기와 시계열 데이터베이스를 좀 더 자세히 알아보자.

![Image](https://github.com/user-attachments/assets/04f619fb-5846-43d8-afdc-b0d37f307f32)

지표 수집기는 서버 클러스터 형태이며 엄청난 양의 데이터를 받아 처리해야 한다.

하지만 시계열 데이터베이스에 장애가 생기면 데이터 손실이 발생할 가능성이 있다.

이때 지표 데이터를 카프카와 같은 큐 시스템에 전송하면 데이터 손실 문제를 해결할 수 있다.

![Image](https://github.com/user-attachments/assets/9762f1fa-a020-4a2a-a650-7f2a932c8ba8)


- 데이터 수집 컴포넌트와 처리 컴포넌트 사이의 결합도를 낮춘다.
- 데이터베이스에 장애가 생겨도 데이터는 소실되지 않는다. 카프카에 보관해두면 되기 때문이다.

