![[스크린샷 2024-12-03 오후 8.23.12.png]]
# 1단계 : 문제 이해 및 설계 범위 확정
- 모바일 앱과 웹을 지원
- 기능
	- 뉴스 피드에 새로운 스토리를 올릴 수 있음
	- 친구의 스토리도 볼 수 있어야 함
- 정렬 : 시간 흐름의 역순
- 한 명당 최대 친구 제한 : 5000명
- 트래픽 규모 : DAU 1000만
- 피드에 이미지나 비디오 업로드 가능해야 함
# 2단계: 개략적 설계안 제시 및 동의 구하기
## 01. 피드 발행
> [! 피드발행]
> - 사용자가 스토리 포스팅 하면 해당 데이터를 캐시와 데이터베이스에 기록
> - 친구의 뉴스피드에도 전송

![[스크린샷 2024-12-03 오후 8.27.54.png]]
- 사용자
	- 모바일 앱이나 브라우저에서 새 포스팅을 올리는 주체
	- POST: /v1/me/feed api 사용
- 로드밸런서(load balancer)
	- 트래픽을 웹 서버들로 분산
- 웹 서버
	- HTTP 요청을 내부 서비스로 중계하는 역할을 담당
- 포스팅 저장 서비스(post service)
	- 새 포스팅을 저장
		- DB
		- Cache
- 포스팅 전송 서비스(fanout service)
	- 새 포스팅을 친구의 뉴스피드에 푸시
	- 뉴스 피드 데이터는 캐시에 보관
- 알림 서비스(notification service)
	- 새 포스팅 알림
	- 푸시 알림
## 02. 피드 생성
![[스크린샷 2024-12-03 오후 8.31.22.png]]
- 사용자
	- 뉴스 피드 읽는 주체
	- GET: /v1/me/feed api 이용
- 로드벨런서
- 웹 서버
	- 트래픽을 뉴스 피드 서비스로 보냄
- 뉴스 피드 서비스(news feed service)
	- 캐시에서 뉴스 피드 조회
- 뉴스 피드 캐시
	- 뉴스 피드 렌더링 할 때 필요 피드 ID 보관
# 3단계: 상세 설계
## 피드 발행 흐름 상세 설계
![[스크린샷 2024-12-03 오후 8.36.36.png]]
- 웹서버
	- 인증 된 사용자만 포스팅 가능
	- 스팸 차단 목적의 포스팅 수 제한
- 포스팅 전송 서비스 (팬아웃)
	- 친구 관계에 있는 사용자에게 전달하는 비즈니스
	- 두 가지 모델 존재
		- 쓰기(푸시) 시점 팬아웃 : 포스팅 기록 시점에 뉴스 피드 갱신
			- 장점
				- 생성 즉시 전송
				- 기록되는 순간 갱신 되므로 새로운 뉴스 피드 읽는데 드는 시간 감소
			- 단점
				- 친구가 많은 경우 뉴스 피드 갱신에 많은 시간 소요 가능성
				- 서비스를 자주 사용하지 않는 사용자의 피드 갱신으로 컴퓨팅 자원 낭비
		- 읽기(풀) 시점 팬아웃 : 읽어야 하는 시점에서 갱신 (사용자가 뉴스 피드를 로딩하는 시점)
			- 장점
				- 비활성화 된 사용자, 서비스에 유리함. 로그인 하기 전 까지 자원 소모 없음
				- 친구에게 푸시하는 작업이 필요 없음
			- 단점
				- 뉴스 피드를 읽는 데 많은 시간 소요 가능성
- 따라서 푸시 팬아웃과 풀 팬아웃의 장점을 합쳐서 개발
	- 뉴스 피드 빠른 수신을 위해 기본적으로 푸시 모델 사용
	- 친구나 팔로어가 아주 많은 사용자는 필요할 떄 가져가도록 풀 모델 사용
	- 안정해시를 통해 요청과 데이터를 고르게 분산
![[스크린샷 2024-12-03 오후 8.49.49.png]]
1. 그래프 DB 에서 친구 ID 목록 가져옴
2. 사용자 정보 캐시에서 친구들 정보 가져옴
	- 친구들 중 누군가 사용자를 차단한 경우 제외
	- 사용자가 피드에 가시성을 제한 한 경우에도 제외
3. 친구 목록과 새 스토리의 포스팅 ID 를 메시지 큐 에 적재
4. 팬아웃 작업 서버 실행
	- 메시지 큐에서 데이터 꺼냄



