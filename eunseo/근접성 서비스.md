## 기능 요구사항
- 사용자의 위치(경도와 위도 쌍)와 검색 반경 정보에 매치되는 사업장 목록을 반환
- 사업장 소유주가 사업장 정보를 추가, 삭제, 갱신할 수 있도록 하되, 그 정보가 검색 결과에 실시간으로 반영될 필요는 없다고 가정
- 고객은 사업장의 상세 정보를 살필 수 있어야 함

## 개략적 규모 추정
- DAU는 1억명, 등록된 사업장 수는 2억이라고 하자.
- 한 사용자는 하루에 5회 검색을 시도한다고 가정한다.
- QPS (Query per second) : (1억 X 5) / 10^5 = 5,000


API 설계
- GET /V1/search/nearby (특정 검색 기준에 맞는 사업장 목록 반환 API
```  
response body
{
	"total" : 10,
  "businesses" : [{business object}]
}
```


- GET /v1/business/{id}
- POST /v1/business
- PUT /v1/business/{id}
- DELETE /v1/business/{id}



![image](https://github.com/user-attachments/assets/c13240a7-82a3-40e2-8885-9f9dfea6c753)


#### 위치 기반 서비스 (LBS)
- LBS는 시스템의 핵심 부분으로, 주어진 위치와 반경 정보를 이용해 주변 사업장을 검색한다.
- 위치 알고리즘으로는 지오해시, 쿼드트리, S2 사용을 추천한다.

#### 상세 설계
데이터베이스 규모 확장
- 사업장 정보 테이블
   - 사업장 ID를 기준으로 샤딩(sharding)을 적용하여 부하 분산
   - 샤딩 : 대규모 데이터베이스의 데이터를 여러 서버에 분산시켜 저장하는 방법 (데이터가 많지 않아서 안해도 됨) 
- 지리 정보 색인 테이블
  -  같은 지오해시에 속한 사업장 ID 각각을 별도 열로 저장 (geohash, business_id)
  -  지리 정보 추정은 1.71G로 샤딩을 안해도 되므로 트래픽이 급증할때는 여러 데이터베이스 서버로 부하를 분산하는 것이 좋다(https://dev.mysql.com/doc/refman/5.7/en/group-replication-primary-secondary-replication.html)
 
- 캐시
   - 키 : 지오해시, 값 : 해당 격자 내의 사업장 id 목록
   - 키 : 사업장ID, 값 : 사업장 정보 객체
   - 데이터는 캐시에 보관하면 시스템의 성능을 전반적으로 향상시킬 수 있다.

## 최종 

![image](https://github.com/user-attachments/assets/9c1a7974-1e3f-42da-989a-0978029bb703)


1. 클라이언트 앱은 사용자의 위치(위도와 경도 정보)와 검색 반경(500미터)을 로드밸런서(lb)로 전송한다.
2. lb는 해당 요청을 LBS(위치 기반 서비스)로 보낸다.
3. 주어진 사용자 위치와 반경 정보에 의거하여, lbs는 검색 요건을 만족할 지오해시 길이를 계산한다. 500미터 정밀도의 지오해시 길이는 6이다. 
4. LBS는 인접한 geohash를 계산한 후 다음 목록에 추가한다.
5. list_of_geohashs 내에 있는 지오해시 각각에 대해 LBS는 레디스 서버를 호출하여 해당 geohash에 대응하는 모든 사업장 id를 가져오는 연산을 병렬적으로 수행한다. 
6. 반환된 사업장 id를 가지고 Business Info(사업장 정보) redis server를 조회하여 각 사업장의 상세 정보를 취득한다. 상세 정보에 의거하여 사업장과 사용자 간 거리를 확실하게 계산하고, 우선순위를 매긴 후 클라언트 앱에 반환한다.



