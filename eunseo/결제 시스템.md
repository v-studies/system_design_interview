![image](https://github.com/user-attachments/assets/ee08b3a2-972d-4bff-9cc1-69c3e445dcd4)

[외부 결제 페이지를 이용 흐름]




1) 결제 지연 처리
- 결제 요청이 최종적으로 완료되면 psp는 사전에 등록된 웹훅을 호출 -> 결제 서비스는 웹훅을 받으면 결제 상태 업데이트
- 웹훅을 통해 결제 서비스에 결제 상태 변경을 알리는 대신, 결제 서비스로 하여금 대기 중인 결제 요청의 상태를 주기적으로 확인하도록(폴링) 하기도 한다

2) 결제 실패 처리
- 일시적 오류 같은 재시도 가능 오류는 재시도 큐에 보낸다.
- 반복적으로 실패한 결제는 최종 환불하거나 실패 메시지큐에 넣어서 별도 처리를 할 수 있다.

3) 정확히 한번 전달
- 최소 한번은 실핸된다 -> 재시도 메커니즘 활용 -> 지수적 백오프(재시도 전에 기다리는 시간을 직전 재시도 대비 두배씩 늘려 나가는 방안) -> 에러코드를 반환할 때는 Retry-After 헤더를 같이 붙여 보내는 것이 바람직
- 최대 한번 실행된다 -> 멱등성 -> 헤더에 <멱등키 : 값> 형태로 요청 -> 이전에 처리한 경우 이전 결제 요청 상태 반환 -> 동일한 멱등키로 동시에 많은 요청을 보내면 하나만 처리하고 나머지는 에런 반환  -> 가장 간단한 방법 db 유니크키

4) 일관성
- 데이터베이스 복제지연 > 주 db에서만 읽기/ 쓰기 연산을 처리 or 모든 사본이 항상 동기화 되도록 한다


5) 결제 보안
- 요청/응답 도청 -> https 사용
- 데이터 변조 -> 암호화 및 무결성 강화 모니터링
