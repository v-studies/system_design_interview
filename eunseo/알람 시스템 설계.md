![image](https://github.com/user-attachments/assets/553274b6-da23-4c9e-b6b0-f297a3adc0fb)

[그림 참조](https://seongho96.tistory.com/116)

1. API를 호출하여 알림 서버로 알림을 보낸다.
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에 가져온다.
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐를 넣는다.
4. 작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다.
5. 작업 서버는 알림을 제3자 서비스로 보낸다.
6. 제3자 서비스는 사용자 단말로 알림을 전송한다.


분산 환경에서 안정성을 확보하기 위해 고려해야할 사항

1) 데이터 손실 방지
알림 내용이 소실되면 안되기 때문에 알림 데이터를 DB에 보관하고 재시도 메커니즘을 구현해야 한다.
-> 대부분 MQ에선 Retry, Dead Letter Queue 기능을 제공하기 때문에 로그 DB를 사용하지 않고 DLQ 기능을 사용해도 될 것 같다.

2) 알림 중복 전송 방지
알림 시스템을 분산 시스템으로 사용할 경우 분산 시스템 특성으로 가끔 알림이 중복된다.
이 중복은 100% 방지하기 어렵다고 한다.
중복을 최대한 방지하기 위해 알림의 이벤트 ID를 검사하는 매커니즘을 사용한다.


추가 고려 사항
- 알림 템플릿
  - 대형 알림 시스템은 하루에 수백만 건 이상의 비슷한 알림을 처리하기 때문에 알림 템플릿을 만들고 캐시나 DB에 저장하여 재사용하는 것이 좋다.

- 알림 설정
  - 너무 많은 알림을 받으면 사용자는 피곤함을 느끼기에 알림 설정을 상세히 조정할 수 있도록 한다.
  - user_id, channel(알림이 전송될 채널. 푸시알림, 이메일, SMS 등), opt_in(해당 채널로 알림을 받을 것인지의 여부) 
  - 새벽에는 발송되지 않도록 예약 알림 기능을 설정한다. 
    
- Late limit (전송률 제한)
   - 사용자에게 너무 많은 알림을 보내는 것을 방지하기 위해 Late limit 도입을 고려한다.

- 재시도 방법
   - retry 횟수를 정하고 해당 횟수를 넘어가면 DLQ 에 저장하고 관계자가 확인할 수 있도록 한다.

- 푸시 알림 보안
   - 알림 전송 API에 Authentication, Authorization 을 도입한다.

- 큐 모니터링
  - 큐에 쌓인 메시지를 메트릭으로 모니터링 하여 큐에 메시지가 많이 쌓인다면 서버 증설을 한다.
  - 큐에 메세지가 많이 쌓이면 슬랙으로 알림을 받도록 설정한다. (컨슘이 제대로 되고 있지 않음을 의미) 

- 이벤트 추적
  - 사용자 행동을 분석하기 위해 알림 확인율, 클릭률, 실제 앱 사용과 같은 메트릭을 이용한다. (FE에서 이벤트로그 삽입 -> 모니터링) EX. Amplitude 
