


## 이메일 프로토콜
(1) SMTP(Simple Mail Transfer Protocol)
 - 이메일을 한 서버에서 다른 서버로 보내는 표준 프로토콜

 
(2) POP(Post Office Protocol)
 - 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신
 - 단말로 다운로드된 이메일은 서버에서 삭제 (한 대 단말에서만 이메일을 읽을 수 있다) 

(3) IMAP(Internet Mail Access Protocol)
 - 이메일 클라이언트가 원격 메일 서버에서 이메일을 수신
 - 클릭하지 않으면 메세지는 다운로드 되지 않으며 원격 메일 서버에서 지워지지 않음


## 분산 메일 서버 아키텍처
![image](https://github.com/user-attachments/assets/3d312f16-4fbf-4565-af60-411f3059e38c)

-  웹 서버 : 사용자가 이용하는 요청/응답 서비스 (로그인, 가입, 사용자 프로파일 등에 대한 관리)
-  실시간 서버 : 새로운 이메일 내역을 클라이언트에 실시간으로 전달 (롱 폴링 or 웹소켓)
-  메타데이터 db : 이메일 제목, 본문, 발신인, 수신인 목록등의 메타 데이터 저장
-  첨부파일 저장소 : s3 사용 (이미지나 동영상 등의 대용량 파일 저장하는데 적합)
-  분산 캐시 : 최근에 수신된 이메일은 자주 읽을 가능성이 높으므로 메모리 캐시 사용 (레디스)
-  검색 저장소  : 고속 텍스트 검색을 지원하는 역 인덱스를 자료구조로 사용


## 이메일 발송 절차
![image](https://github.com/user-attachments/assets/ed543d9f-2cbd-4eb5-ba89-ce8e0afb4f5c)

- 메세지큐는 비동기적 메일 처리를 가능케 한다.
- 웹서버에서 외부 전송 담당 SMTP 프로세스를 분리함으로써 전송용 SMTP 프로세스의 규모를 독립적으로 조정할 수 있다.

## 이메일 수신 절차

![image](https://github.com/user-attachments/assets/5cbcf350-7d7b-43e8-afa7-743222412c9c)

- SMTP 서버: 첨부파일이 큐에 들어가기 너무 큰 경우에는 첨부파일 저장소(S3)에 보관한다
- 메일 처리 작업 프로세스(worker): 이메일 큐에서 이메일을 꺼내, 이메일의 스팸 및 바이러스 감염 여부 확인한다.
- 실시간 서버는 수신자 클라이언트가 새 이메일을 실시간으로 받을 수 있도록 하는 웹소켓 서버
- 오프라인 상태의 사용자의 이메일은 저장소 계층에 보관  -> 해당 사용자가 온라인 상태가 되면 restful api 통해 연결 


### 상세 설계

(1) 데이터베이스
- 지메일/아웃룩 규모가 되면 보통 초당 입/출력 연산빈도를 낮추기 위해 맞춤 제작한 db를 사용한다.
- 관계형 데이터베이스( 검색 질의 빠르게 처리, 데이터가 많으면 디스크 I/O 발생)
- NoSQL (지메일 - 구글 빅테이블을 저장소로 사용, 이메일 검색을 빅테이블 위에서 어떻게 구현했는지는 미스터리) 

(2) 일관성 
- 이메일 시스템의 경우 데이터의 일관성이 중요하여 가용성이 희생될 수 있다. (장애가 발생하면 주 사본이 복원될 때까지 동기화/갱신 작업을 완료할 수 없다)

